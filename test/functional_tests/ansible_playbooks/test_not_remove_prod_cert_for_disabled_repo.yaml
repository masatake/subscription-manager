---
- hosts: clients
  vars:
    repos: ['100000000000002-awesomeos-x86_64', '100000000000002-awesomeos', '213412341237-awesomeos-x86_64-i386-content']
    packages: ['awesome-sheep', 'awesome-rabbit', 'awesome-cow']
  remote_user: root

  tasks:
  
    - name: enable repositories
      shell: subscription-manager repos --enable {{ item }}
      with_items: "{{ repos }}"

    # - name: install packages
    #   package:
    #     name: "{{ item }}"
    #     state: present
    #   with_items: "{{ packages }}"

    - name: install packages (CentOS - yum)
      shell: yum install -y "{{ item }}"
      args:
        warn: false
      with_items: "{{ packages }}"
      when:
      - ansible_facts['distribution'] == "CentOS"

    - name: install packages (Fedora - dnf)
      shell: dnf install -y "{{ item }}"
      args:
        warn: false
      with_items: "{{ packages }}"
      when:
      - ansible_facts['distribution'] == "Fedora"

    - name: disable 213412341237-awesomeos-x86_64-i386-content repository
      shell: subscription-manager repos --disable 213412341237-awesomeos-x86_64-i386-content

    # - name: remove package awesome-rabbit
    #   package:
    #     name: awesome-rabbit
    #     state: absent

    - name: remove package awesome-rabbit (CentOS - yum)
      shell: yum remove -y awesome-rabbit
      args:
        warn: false
      when:
      - ansible_facts['distribution'] == "CentOS"

    - name: remove package awesome-rabbit (Fedora - dnf)
      shell: dnf remove -y awesome-rabbit
      args:
        warn: false
      when:
      - ansible_facts['distribution'] == "Fedora"

    - name: test 100000000000002.pem product cert is still installed
      shell: test -f /etc/pki/product/100000000000002.pem

    # Product certificate cannot be removed now, because package awesome-cow
    # is still installed
    - name: test 213412341237.pem product cert is still installed
      shell: test -f /etc/pki/product/213412341237.pem

    # - name: remove package awesome-cow
    #   package:
    #     name: awesome-cow
    #     state: absent

    - name: remove package awesome-cow (CentOS - yum)
      shell: yum remove -y awesome-cow
      args:
        warn: false
      when:
      - ansible_facts['distribution'] == "CentOS"

    - name: remove package awesome-cow (Fedora - dnf)
      shell: dnf remove -y awesome-cow
      args:
        warn: false
      when:
      - ansible_facts['distribution'] == "Fedora"

    # Product certificate should be removed now, because all packages
    # from disabled repositories are removed now
    - name: test 213412341237.pem product cert was
      shell: test ! -f /etc/pki/product/213412341237.pem

    # End of testing remove all testing packages and disable all testing repositories

    # - name: remove all testing packages
    #   package:
    #     name: "{{ item }}"
    #     state: absent
    #   with_items: "{{ packages }}"

    - name: remove all testing packages (CentOS - yum)
      shell: yum remove -y "{{ item }}"
      args:
        warn: false
      with_items: "{{ packages }}"
      when:
      - ansible_facts['distribution'] == "CentOS"

    - name: install all testing packages (Fedora - dnf)
      shell: dnf remove -y "{{ item }}"
      args:
        warn: false
      with_items: "{{ packages }}"
      when:
      - ansible_facts['distribution'] == "Fedora"

    - name: disable repositories
      shell: subscription-manager repos --disable {{ item }}
      with_items: "{{ repos }}"